import dotenv from "dotenv"
dotenv.config()

import { Telegraf } from "telegraf"
import askAI from "./utils/openai"

const BOT_TOKEN = process.env.BOT_TOKEN!
const bot = new Telegraf(BOT_TOKEN)

const userHistories = new Map<number, string[]>()

bot.start((context) => {
  const userId = context.from.id
  userHistories.set(userId, [])

  const welcomeMessage = `Ø³Ù„Ø§Ù… ${context.from.first_name} Ø¬Ø§Ù†! âœ¨
Ù…Ù† Â«Ù†ÙˆÛŒØ³Ø§Â» Ù‡Ø³ØªÙ…ØŒ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ ØªÙˆ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù†ÙˆØ¹ ÙˆÛŒØ±Ø§ÛŒØ´ Ù…ØªÙ†ÛŒ!

**Ø§ÛŒÙ†â€ŒØ¬Ø§ Ú©Ù„ÛŒ Ø®Ø¯Ù…Ø§Øª Ø¯Ø§Ø±Ù… Ø¨Ø±Ø§Øª:**

ğŸ“ **ÙˆÛŒØ±Ø§ÛŒØ´ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ:**
- Ø§ØµÙ„Ø§Ø­ ØªÙ…Ø§Ù… ØºÙ„Ø·â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù„Ø§ÛŒÛŒ Ùˆ Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª ØªØ§ÛŒÙ¾ÛŒ
- Ø±ÙØ¹ Ù…Ø´Ú©Ù„Ø§Øª Ø¯Ø³ØªÙˆØ±ÛŒ Ùˆ Ù†Ú¯Ø§Ø±Ø´ÛŒ
- Ø¨Ù‡Ø¨ÙˆØ¯ Ø³Ø§Ø®ØªØ§Ø± Ø¬Ù…Ù„Ø§Øª Ø¨Ø±Ø§ÛŒ Ø±ÙˆØ§Ù†â€ŒØªØ± Ø´Ø¯Ù† Ù…ØªÙ†

ğŸ­ **ØªØºÛŒÛŒØ± Ù„Ø­Ù† Ø¨Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ ØªÙˆ:**
- Ø±Ø³Ù…ÛŒ Ùˆ Ø§Ø¯Ø§Ø±ÛŒ (Ø¨Ø±Ø§ÛŒ Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ØŒ Ø§ÛŒÙ…ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±ÛŒ)
- Ø®ÙˆØ¯Ù…Ø§Ù†ÛŒ Ùˆ ØµÙ…ÛŒÙ…ÛŒ (Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯ÙˆØ³ØªØ§Ù†Ù‡)
- Ù†ÛŒÙ…Ù‡â€ŒØ±Ø³Ù…ÛŒ (Ø¨Ø±Ø§ÛŒ Ù…Ú©Ø§ØªØ¨Ø§Øª Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ÛŒ)
- Ø·Ù†Ø² Ùˆ Ø®Ù„Ø§Ù‚Ø§Ù†Ù‡ (Ø¨Ø±Ø§ÛŒ Ù¾Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ø¨Ú©Ù‡â€ŒØ§Ø¬ØªÙ…Ø§Ø¹ÛŒ)

ğŸ“ **ØªÙ†Ø¸ÛŒÙ… Ø·ÙˆÙ„ Ù…ØªÙ†:**
- Ø®Ù„Ø§ØµÙ‡â€ŒÙ†ÙˆÛŒØ³ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ (ØªØ§ 50% Ú©ÙˆØªØ§Ù‡â€ŒØªØ±)
- Ø¨Ø³Ø· Ùˆ Ú¯Ø³ØªØ±Ø´ Ù…ØªÙ† (ØªØ§ 3 Ø¨Ø±Ø§Ø¨Ø± Ø·ÙˆÙ„Ø§Ù†ÛŒâ€ŒØªØ±)
- ØªÙ†Ø¸ÛŒÙ… Ø¯Ù‚ÛŒÙ‚ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„Ù…Ø§Øª Ù…Ø¯Ù†Ø¸Ø± ØªÙˆ

âœï¸ **Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ:**
- Ù¾Ø§Ø±Ø§ÙØ±ÛŒØ² Ú©Ø±Ø¯Ù† Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ù…Ø¹Ù†Ø§
- Ø¨Ù‡Ø¨ÙˆØ¯ Ø³Ù„Ø§Ø³Øª Ùˆ ØªØ§Ø«ÛŒØ±Ú¯Ø°Ø§Ø±ÛŒ Ù…ØªÙ†
- Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ø³Ø¦Ùˆ (Ø¨Ø±Ø§ÛŒ Ù…Ø­ØªÙˆØ§ÛŒ ÙˆØ¨)
- ØªØ¨Ø¯ÛŒÙ„ Ú¯ÙØªØ§Ø± Ø¹Ø§Ù…ÛŒØ§Ù†Ù‡ Ø¨Ù‡ Ù†ÙˆØ´ØªØ§Ø± Ø±Ø³Ù…ÛŒ

Ù…Ø«Ø§Ù„ Ø®Ø¯Ù…Ø§ØªÙ…:
"ÛŒÙ‡ Ù…ØªÙ† Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø§ÛŒÙ†ØªØ±Ù†ØªÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù…" â”
"ğŸ›ï¸ ÙØ±ÙˆØ´ ÙˆÛŒÚ˜Ù‡ ØªØ§Ø¨Ø³ØªØ§Ù†Ù‡! 
ØªØ§ 50% ØªØ®ÙÛŒÙ Ø±ÙˆÛŒ ØªÙ…Ø§Ù… Ù…Ø­ØµÙˆÙ„Ø§Øª 
ÙÙ‚Ø· ØªØ§ Ù¾Ø§ÛŒØ§Ù† Ø§ÛŒÙ† Ù‡ÙØªÙ‡ â³"

Ø­Ø§Ù„Ø§ Ø¨Ú¯Ùˆ Ú†Ù‡ Ù…ØªÙ†ÛŒ Ø¯Ø§Ø±ÛŒØŸ Ù…Ù† Ø¢Ù…Ø§Ø¯Ù‡ Ú©Ù…Ú©Ù…! ğŸ’Œ`

  context.reply(welcomeMessage)
})

bot.on("text", async (context) => {
  const userId = context.from.id
  const userText = context.message.text

  const loadingMessage = await context.reply("Ø¨Ø²Ø§Ø± Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†Ù… ØªØ§ Ø¨Ù‡Øª Ø¬ÙˆØ§Ø¨ Ø¨Ø¯Ù…!")

  const history = userHistories.get(userId) ?? []
  const newHistory = [...history, userText]
  const trimmedHistory = newHistory.slice(-10)
  userHistories.set(userId, trimmedHistory)

  const aiResponse = await askAI(trimmedHistory)

  const editedText =
    aiResponse.content ??
    `Ù…ØªØ§Ø³ÙÙ…ØŒ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯Ù‡ Ùˆ Ù†ØªÙˆÙ†Ø³ØªÙ… Ù…ØªÙ† Ø±Ùˆ Ø¨Ø±Ø§Øª ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†Ù…! Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†.`

  await context.telegram.editMessageText(
    context.chat.id,
    loadingMessage.message_id,
    undefined,
    editedText,
    {
      parse_mode: "Markdown",
    }
  )
})

bot.launch()
